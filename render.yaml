# Render Blueprint for VoiceFlow CRM
# One-click deployment to Render
# Documentation: https://render.com/docs/blueprint-spec
#
# IMPORTANT: After deployment, you MUST set these environment variables in Render Dashboard:
# - MONGO_URI (MongoDB Atlas connection string)
# - ELEVENLABS_API_KEY and all agent IDs
# - TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN
# - STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET, and all price IDs
# - EMAIL_USER and EMAIL_PASS
# - VITE_STRIPE_PUBLISHABLE_KEY (for frontend)

services:
  # Backend API Service
  - type: web
    name: voiceflow-api
    runtime: node
    region: oregon
    plan: starter
    branch: main
    buildCommand: npm install
    startCommand: node backend/server.js
    healthCheckPath: /health

    envVars:
      - key: NODE_ENV
        value: production

      - key: PORT
        value: 5001

      # Database - SET IN RENDER DASHBOARD
      - key: MONGO_URI
        sync: false

      # Redis - Can use Render Redis or Redis Cloud
      - key: REDIS_URL
        sync: false

      # JWT - Auto-generated
      - key: JWT_SECRET
        generateValue: true

      - key: JWT_EXPIRE
        value: 7d

      # Application URLs - Update after custom domain setup
      - key: CLIENT_URL
        value: https://voiceflow-app.onrender.com

      - key: API_URL
        value: https://voiceflow-api.onrender.com

      # ElevenLabs - SET IN RENDER DASHBOARD
      - key: ELEVENLABS_API_KEY
        sync: false

      - key: ELEVENLABS_LEAD_GEN_AGENT_ID
        sync: false

      - key: ELEVENLABS_BOOKING_AGENT_ID
        sync: false

      - key: ELEVENLABS_COLLECTIONS_AGENT_ID
        sync: false

      - key: ELEVENLABS_PROMO_AGENT_ID
        sync: false

      - key: ELEVENLABS_SUPPORT_AGENT_ID
        sync: false

      # Twilio - SET IN RENDER DASHBOARD
      - key: TWILIO_ACCOUNT_SID
        sync: false

      - key: TWILIO_AUTH_TOKEN
        sync: false

      # Stripe LIVE keys - SET IN RENDER DASHBOARD
      - key: STRIPE_SECRET_KEY
        sync: false

      - key: STRIPE_PUBLISHABLE_KEY
        sync: false

      - key: STRIPE_WEBHOOK_SECRET
        sync: false

      - key: STRIPE_PRICE_STARTER
        sync: false

      - key: STRIPE_PRICE_PROFESSIONAL
        sync: false

      - key: STRIPE_PRICE_ENTERPRISE
        sync: false

      # Email - SET IN RENDER DASHBOARD
      - key: EMAIL_USER
        sync: false

      - key: EMAIL_PASS
        sync: false

      - key: EMAIL_FROM
        value: VoiceFlow CRM <noreply@yourdomain.com>

      # Security
      - key: RATE_LIMIT_WINDOW
        value: 15

      - key: RATE_LIMIT_MAX_REQUESTS
        value: 100

      - key: SESSION_SECRET
        generateValue: true

      - key: COOKIE_SECURE
        value: true

      - key: COOKIE_SAME_SITE
        value: strict

      - key: CORS_ORIGINS
        value: https://voiceflow-app.onrender.com,https://app.voiceflow.ai

      # Feature Flags
      - key: ENABLE_SIGNUP
        value: true

      - key: ENABLE_GOOGLE_AUTH
        value: false

      - key: ENABLE_TRIAL
        value: true

      - key: TRIAL_DAYS
        value: 14

  # Frontend Static Site
  - type: web
    name: voiceflow-app
    runtime: static
    region: oregon
    branch: main
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist

    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN

      - path: /*
        name: X-Content-Type-Options
        value: nosniff

      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block

      - path: /assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable

    envVars:
      - key: VITE_API_URL
        value: https://voiceflow-api.onrender.com

      - key: VITE_STRIPE_PUBLISHABLE_KEY
        sync: false
